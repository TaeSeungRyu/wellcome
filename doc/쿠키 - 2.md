# 🔐 JWT를 쿠키에 저장할 때 보안 전략

JWT(JSON Web Token)를 브라우저에 저장하는 방법 중 하나는 **쿠키(Cookie)** 를 사용하는 것입니다.
하지만 잘못 설정하면 **XSS, CSRF, 토큰 탈취, 재사용 공격** 등에 취약해질 수 있습니다.

아래는 JWT를 **쿠키에 안전하게 저장하기 위한 실무 보안 전략**입니다.

---

## 1️⃣ HttpOnly + Secure + SameSite 필수 설정

### ✅ 기본 권장 설정

```http
Set-Cookie: accessToken=xxx.yyy.zzz; 
  HttpOnly; 
  Secure; 
  SameSite=Lax; 
  Path=/; 
  Max-Age=3600
```

### 🔹 HttpOnly

* JavaScript에서 접근 불가
* XSS로 인한 토큰 탈취 방지

### 🔹 Secure

* HTTPS에서만 전송
* 네트워크 스니핑 방지

### 🔹 SameSite

* `Lax` → 일반 웹 서비스 기본값
* `Strict` → 보안 최우선
* `None` → 반드시 `Secure`와 함께 (소셜 로그인 등)

---

## 2️⃣ Access Token과 Refresh Token 분리 전략

### 💡 권장 구조

| 토큰            | 저장 위치       | 만료 시간       | 역할         |
| ------------- | ----------- | ----------- | ---------- |
| Access Token  | HttpOnly 쿠키 | 짧게 (10~30분) | API 인증     |
| Refresh Token | HttpOnly 쿠키 | 길게 (7~14일)  | Access 재발급 |

---

### 🔹 왜 분리하는가?

* Access Token 탈취 시 피해 최소화
* Refresh Token으로 재발급 가능
* 짧은 Access 만료로 보안 강화

---

## 3️⃣ CSRF 방어 전략

JWT를 쿠키에 저장하면 **자동으로 요청에 포함되므로 CSRF 위험이 존재**합니다.

### 🔹 대응 방법 1: SameSite=Lax 이상 설정

```http
SameSite=Lax
```

대부분의 CSRF 공격 차단 가능

---

### 🔹 대응 방법 2: CSRF Token 추가 (Double Submit Pattern)

1. 서버가 CSRF 토큰을 생성
2. 쿠키 + 헤더에 동시에 전송
3. 서버에서 값 비교

```http
X-CSRF-Token: random-value
```

👉 상태 변경 요청(POST, PUT, DELETE)에 적용

---

## 4️⃣ Refresh Token 보안 강화

Refresh Token은 장기 토큰이므로 추가 보안이 필요합니다.

### 🔹 전략

* DB 또는 Redis에 저장 (화이트리스트 방식)
* 토큰 회전(Rotation) 적용
* 재사용 감지(Reuse Detection)

---

### 🔹 Refresh Token Rotation

1. Refresh 요청 시
2. 기존 Refresh Token 무효화
3. 새 Refresh Token 발급

👉 탈취된 토큰 재사용 방지

---

## 5️⃣ JWT Payload 최소화

JWT는 Base64로 인코딩되어 **누구나 디코딩 가능**합니다.

❌ 나쁜 예

```json
{
  "userId": 1,
  "password": "1234"
}
```

✅ 좋은 예

```json
{
  "sub": "1",
  "role": "USER"
}
```

* 민감 정보 저장 금지
* 최소한의 인증 정보만 포함

---

## 6️⃣ 짧은 만료 시간 설정

```json
{
  "exp": 1710000000
}
```

* Access Token: 10~30분
* Refresh Token: 7~14일
* 만료 시간은 반드시 설정

---

## 7️⃣ 로그아웃 처리 전략

### 🔹 서버 측 처리

1. Refresh Token DB 삭제
2. 쿠키 만료 처리

```http
Set-Cookie: refreshToken=; Max-Age=0; HttpOnly; Secure
```

---

## 8️⃣ 쿠키 vs LocalStorage 비교

| 항목      | 쿠키(HttpOnly) | LocalStorage |
| ------- | ------------ | ------------ |
| XSS 방어  | ✅ 안전         | ❌ 취약         |
| CSRF 위험 | ⚠️ 있음        | 없음           |
| 자동 전송   | ✅ 자동 포함      | ❌ 수동 헤더 추가   |

👉 보안 우선이라면 **HttpOnly 쿠키 권장**

---

# 🚀 실무 권장 아키텍처

```
[Client]
  ├─ Access Token (HttpOnly, Secure, SameSite=Lax)
  └─ Refresh Token (HttpOnly, Secure, SameSite=Strict)

[Server]
  ├─ Refresh Token 저장 (DB/Redis)
  ├─ Rotation 적용
  └─ 재사용 감지
```

---

# 🔥 최종 정리

JWT를 쿠키에 저장할 때는:

* ✅ HttpOnly
* ✅ Secure
* ✅ SameSite
* ✅ Access / Refresh 분리
* ✅ Refresh Rotation
* ✅ CSRF 방어
* ✅ 짧은 만료 시간
* ✅ Payload 최소화

---