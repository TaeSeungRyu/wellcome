# 🔐 OAuth2 + JWT 쿠키 전략 (이론 정리)

OAuth2 기반 로그인(소셜 로그인 포함)에서 JWT를 쿠키에 저장할 때는
**인증 흐름 + 토큰 관리 + 쿠키 보안 설정 + CSRF 대응**까지 함께 설계해야 합니다.

---

## 1️⃣ OAuth2 기본 개념

### 🔹 OAuth2란?

**인가(Authorization) 프레임워크**로,
사용자가 자신의 비밀번호를 직접 공유하지 않고도 제3자 서비스에 접근 권한을 위임할 수 있게 해줍니다.

대표적인 제공자:

* Google
* Kakao
* Naver
* GitHub

---

## 2️⃣ OAuth2 인증 흐름 (Authorization Code Grant)

가장 안전하고 일반적인 방식은 **Authorization Code Grant**입니다.

### 🔁 전체 흐름

```
1. 클라이언트 → OAuth Provider 로그인 요청
2. Provider → Authorization Code 발급
3. 클라이언트 → 서버에 Code 전달
4. 서버 → Provider에 Access Token 요청
5. 서버 → 사용자 정보 조회
6. 서버 → 자체 JWT 발급
7. JWT를 HttpOnly 쿠키로 저장
```

💡 핵심:
**OAuth Access Token은 내부 검증용**,
**서비스 인증은 자체 JWT로 처리**하는 것이 일반적입니다.

---

# 3️⃣ OAuth2 + JWT 구조 설계

## 🔹 왜 자체 JWT를 발급하는가?

OAuth Provider의 Access Token은:

* 만료 정책 제어 불가
* 내부 권한 모델과 불일치
* Provider 변경 시 종속성 발생

따라서 보통:

```
[OAuth Access Token] → 사용자 식별용
[우리 서비스 JWT] → 실제 인증용
```

---

# 4️⃣ JWT를 쿠키에 저장하는 이유

브라우저 환경에서 JWT 저장 방식은 크게 두 가지입니다:

| 저장 위치           | 특징       |
| --------------- | -------- |
| LocalStorage    | XSS에 취약  |
| HttpOnly Cookie | JS 접근 불가 |

👉 보안 우선이라면 **HttpOnly Cookie 방식 권장**

---

# 5️⃣ OAuth2 + JWT 쿠키 전략 구조

## 📌 권장 구조

```
[브라우저]
  ├─ accessToken (HttpOnly, Secure, SameSite=Lax)
  └─ refreshToken (HttpOnly, Secure, SameSite=Strict)

[서버]
  ├─ Refresh Token 저장 (DB/Redis)
  ├─ Rotation 적용
  └─ 재사용 감지
```

---

# 6️⃣ 쿠키 보안 설정 전략

## ✅ Access Token 쿠키

```http
HttpOnly
Secure
SameSite=Lax
Max-Age=900  (15분)
```

* API 인증용
* 짧은 만료 시간

---

## ✅ Refresh Token 쿠키

```http
HttpOnly
Secure
SameSite=Strict
Path=/auth/refresh
Max-Age=1209600 (14일)
```

* 재발급 전용
* Path 제한으로 공격 범위 최소화

---

# 7️⃣ CSRF 대응 전략

JWT를 쿠키에 저장하면 자동으로 요청에 포함되므로
**CSRF 공격 가능성**이 존재합니다.

### 🔹 대응 방법

### 1️⃣ SameSite=Lax 이상 설정

* 대부분의 CSRF 차단

### 2️⃣ CSRF Token 사용 (Double Submit Cookie)

```
X-CSRF-Token 헤더
```

* 상태 변경 요청에 필수

---

# 8️⃣ OAuth2 로그인 시 주의점

## ⚠️ 1. State 파라미터 사용

OAuth2 요청 시:

```
/authorize?state=random-value
```

* CSRF 방지 목적
* 서버에서 검증 필수

---

## ⚠️ 2. Redirect URI 고정

* 사전에 등록된 URI만 허용
* Open Redirect 취약점 방지

---

## ⚠️ 3. PKCE 사용 (SPA 환경 필수)

* Public Client에서 Code 탈취 방지
* 모바일 / SPA에서는 반드시 적용

---

# 9️⃣ Refresh Token Rotation

OAuth2 + JWT 환경에서 가장 중요한 보안 전략 중 하나입니다.

### 🔁 동작 방식

```
1. Refresh 요청
2. 기존 Refresh Token 무효화
3. 새 Access + Refresh 발급
4. DB에 새 Refresh 저장
```

👉 탈취된 Refresh Token 재사용 차단

---

# 🔥 전체 아키텍처 정리

```
[1] OAuth Provider 로그인
[2] Authorization Code 수신
[3] 서버에서 Access Token 교환
[4] 사용자 정보 조회
[5] 자체 JWT 발급
[6] HttpOnly 쿠키 저장
[7] Access 만료 시 Refresh로 재발급
```

---

# 🎯 보안 체크리스트

* ✅ OAuth Access Token을 직접 프론트에 노출하지 않기
* ✅ 자체 JWT 발급
* ✅ HttpOnly + Secure 필수
* ✅ SameSite=Lax 이상
* ✅ Refresh Token DB 저장
* ✅ Rotation 적용
* ✅ state 값 검증
* ✅ PKCE 적용

---

# 📌 핵심 요약

OAuth2 + JWT 쿠키 전략의 본질은:

> **외부 인증은 OAuth2, 내부 인증은 JWT, 저장은 안전한 쿠키**

즉,

* OAuth2 → 신원 확인
* JWT → 서비스 인증
* Cookie → 안전한 저장
* Rotation → 장기 보안 유지

---